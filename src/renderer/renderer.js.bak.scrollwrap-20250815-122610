const $ = id => document.getElementById(id);

let state = { unlocked: false, peers: 0 };
let refreshing = false;
let nextTimer = null;
let last = { bal: null, stakeAmt: null, stakeOn: null, vp: 0 };

function setSync(pct, text) {
  const bar = $('syncbar'); if (bar) bar.style.width = Math.max(0, Math.min(100, pct || 0)) + '%';
  const t = $('syncText'); if (t) t.textContent = text || '';
  const syncChip = $('ic-sync'); if (syncChip) syncChip.classList.toggle('ok', (pct || 0) >= 100);
}

function setPeers(n) {
  state.peers = n || 0;
  const chip = $('ic-peers');
  if (chip) { chip.title = `Peers: ${state.peers}`; chip.classList.toggle('ok', state.peers > 0); }
}

function setLock(unlocked) {
  state.unlocked = !!unlocked;
  const p = $('p-lock'); if (!p) return;
  if (state.unlocked) {
    p.setAttribute('d', 'M9 10V7a3 3 0 0 1 6 0h2a5 5 0 1 0-10 0v3H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2H9zm3 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z');
  } else {
    p.setAttribute('d', 'M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm3 8H9V7a3 3 0 016 0v3z');
  }
  const chip = $('ic-lock');
  if (chip) { chip.classList.toggle('ok', state.unlocked); chip.title = state.unlocked ? 'Wallet unlocked' : 'Wallet locked'; }
}

function setStaking(on, amount) {
  const chip = $('ic-stake'); if (chip) { chip.classList.toggle('ok', !!on); chip.title = on ? 'Staking on' : 'Staking off'; }
  const s = $('staking'); if (s) s.textContent = on ? Number(amount || 0).toLocaleString() : '0';
}

let __resizeRAF=null;
function fitBalance() {
  const box = $('bignum'), span = $('big-balance');
  if (!box || !span) return;
  const ctx = document.createElement('canvas').getContext('2d');
  const font = s => `800 ${s}px -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif`;
  let size = 72, max = box.clientWidth - 30;
  while (size > 36) { ctx.font = font(size); if (ctx.measureText(span.textContent).width <= max) break; size -= 2; }
  span.style.fontSize = size + 'px';
}

function scheduleRefresh(ms) {
  if (nextTimer) clearTimeout(nextTimer);
  nextTimer = setTimeout(refresh, ms);
}

async function refresh() {
  if (refreshing) return; // prevent overlap
  refreshing = true;
  try {
    const st = await window.ioc.status();
    const info = st?.info || {};
    const bal = Number(info.balance || info.walletbalance || 0);

    if (last.bal !== bal) {
      const el = $('big-balance');
      if (el) el.textContent = (Math.round(bal * 1000) / 1000).toLocaleString();
      last.bal = bal; fitBalance();
    }

    const blocks = st?.chain?.blocks || 0;
    const headers = st?.chain?.headers || blocks || 0;
    const vp = typeof st?.chain?.verificationprogress === 'number' ? st.chain.verificationprogress : (headers ? blocks / headers : 0);
    const pct = Math.round((vp || 0) * 100);
    if (last.vp !== vp) {
      setSync(pct, `Syncing wallet (${blocks} / ${headers} blocks)`);
      last.vp = vp;
    }

    setPeers(st?.peers || 0);

    const locked = st?.lockst?.isLocked;
    if (typeof locked === 'boolean') setLock(!locked);

    // staking ON flag (unchanged)
    const stakingOn = !!(st?.staking?.staking || st?.staking?.enabled);
    // staking AMOUNT (prefer getinfo.stake, fallback to getstakinginfo fields)
    const stakingAmt = Number(
      (typeof info.stake !== 'undefined') ? info.stake :
      (st?.staking && typeof st.staking.stake !== 'undefined') ? st.staking.stake :
      (st?.staking && typeof st.staking.stakingbalance !== 'undefined') ? st.staking.stakingbalance : 0
    );

    if (stakingOn !== last.stakeOn || stakingAmt !== last.stakeAmt) {
      setStaking(stakingOn, stakingAmt);
      last.stakeOn = stakingOn; last.stakeAmt = stakingAmt;
    }
  } catch {}
  finally {
    refreshing = false;
    // Adaptive polling: faster while syncing, slower when synced; extra-slow when tab/window hidden
    const isHidden = document.hidden;
    const vp = last.vp || 0;
    const base = vp < 0.999 ? 1500 : 4000;
    const delay = isHidden ? Math.max(base, 10000) : base;
    scheduleRefresh(delay);
  }
}

async function loadHistory_OLD() {
  const rows = await window.ioc.listTx(50);
  const tbody = $('txrows'); if (!tbody) return;
  tbody.innerHTML = '';
  rows.forEach(t => {
    const tr = document.createElement('tr');
    const when = new Date((t.timereceived || t.time || 0) * 1000).toLocaleString();
    tr.innerHTML = `<td class="col-when">${when}</td><td class="col-amt">${t.amount || 0}</td><td class="col-addr">${t.address || t.txid || ""}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadAddrs() {
  const grid = $('addrGrid'); if (!grid) return;
  grid.innerHTML = '';
  const xs = await window.ioc.listAddrs();
  xs.forEach(x => {
    const card = document.createElement('div');
    card.className = 'addr-card';
    card.innerHTML = `<div class="label">${x.label || 'Address'}</div>
      <div class="addr" title="Balance: ${Number(x.amount || 0).toLocaleString()}">${x.address}</div>`;
    grid.appendChild(card);
  });
}

function switchTab(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  $('tab-' + name).classList.remove('hidden');
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  if (name === 'history') loadHistory();
  if (name === 'address') loadAddrs();
}

async function doUnlock() {
  const pass = ($('pass').value || '').trim(); if (!pass) return;
  $('unlockErr').textContent = '';
  try {
    await window.ioc.rpc('walletpassphrase', [pass, 9999999]);
    await window.ioc.rpc('reservebalance', [false]);
    setTimeout(() => { setLock(true); $('unlockModal').classList.add('hidden'); $('pass').value=''; refresh(); }, 300);
  } catch { $('unlockErr').textContent = 'Wrong passphrase'; }
}

async function onLockClick() {
  if (state.unlocked) {
    try {
      await window.ioc.rpc('reservebalance', [true, 999999999]);
      await window.ioc.rpc('walletlock', []);
      setLock(false);
      setStaking(false, 0);
      refresh();
    } catch {}
  } else {
    $('unlockModal').classList.remove('hidden');
    setTimeout(() => $('pass').focus(), 0);
  }
}

/** New Address flow */
function openNewAddrModal() {
  $('newLabel').value = '';
  $('newAddrErr').textContent = '';
  $('newAddrResult').classList.add('hidden');
  $('newAddrResult').textContent = '';
  $('newAddrModal').classList.remove('hidden');
  setTimeout(() => $('newLabel').focus(), 0);
}

async function createNewAddr() {
  const label = ($('newLabel').value || '').trim();
  $('newAddrErr').textContent = '';
  const res = await window.ioc.newAddr(label);
  if (!res?.ok) { $('newAddrErr').textContent = 'Could not create address (daemon not ready?)'; return; }
  const out = $('newAddrResult');
  out.textContent = res.address;
  out.classList.remove('hidden');
  setTimeout(loadAddrs, 300);
  setTimeout(() => { $('newAddrModal').classList.add('hidden'); }, 1200);
}

function main() {
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
  window.addEventListener('resize',()=>{if(__resizeRAF)cancelAnimationFrame(__resizeRAF);__resizeRAF=requestAnimationFrame(()=>{__resizeRAF=null;fitBalance();});});

  document.addEventListener('visibilitychange', () => {
    // When returning to the app, refresh immediately; when hiding, the next tick will stretch.
    if (!document.hidden) refresh();
  });

  $('ic-lock').addEventListener('click', onLockClick);
  $('cancelUnlock').addEventListener('click', () => { $('unlockModal').classList.add('hidden'); $('pass').value=''; });
  $('doUnlock').addEventListener('click', doUnlock);
  $('pass').addEventListener('keydown', e => { if (e.key === 'Enter') doUnlock(); if (e.key === 'Escape') {$('unlockModal').classList.add('hidden');} });

  $('sendBtn').addEventListener('click', () => $('sendModal').classList.remove('hidden'));
  $('cancelSend').addEventListener('click', () => $('sendModal').classList.add('hidden'));
  $('doSend').addEventListener('click', async () => {
    const a = ($('sendAddr').value||'').trim();
    const n = parseFloat(($('sendAmt').value||'').trim());
    if (!a || !(n>0)) return;
    if (!state.unlocked) { $('unlockModal').classList.remove('hidden'); return; }
    try { await window.ioc.rpc('sendtoaddress', [a, n]); $('sendModal').classList.add('hidden'); setTimeout(refresh, 400); } catch {}
  });

  $('newAddrBtn').addEventListener('click', openNewAddrModal);
  $('cancelNewAddr').addEventListener('click', () => $('newAddrModal').classList.add('hidden'));
  $('createNewAddr').addEventListener('click', createNewAddr);
  $('newLabel').addEventListener('keydown', e => { if (e.key === 'Enter') createNewAddr(); if (e.key === 'Escape') {$('newAddrModal').classList.add('hidden');}});

  // Kick off the adaptive loop
  refresh();
}
document.addEventListener('DOMContentLoaded', ()=>{ main(); try{ ensureHistoryLayout(); }catch(_){}});

(function(){
  if (document.getElementById("hist-cols-css")) return;
  var css = `
    /* History table column sizing */
    #history-pane table{ table-layout:auto; width:100%; }
    #history-pane th, #history-pane td{ white-space:nowrap; }
    /* When column ~260px */
    #history-pane .col-when{ width:260px; }
    /* Amount column ~80px, right aligned */
    #history-pane .col-amt{ width:80px; text-align:right; }
    /* Address column uses the rest, no clipping/ellipsis */
    #history-pane .col-addr{ white-space:nowrap; overflow:visible; }
  `;
  var el = document.createElement("style");
  el.id = "hist-cols-css";
  el.textContent = css;
  document.head.appendChild(el);
})();


;(function(){
  function q(id){return document.getElementById(id)}
  async function rpc(m, a){ try { return await window.ioc.rpc(m, a||[]) } catch(e){ throw e } }

  function setupWalletTools(){
    var d=q('btnDump'), imp=q('btnImport'), op=q('btnOpenPath');
    if (op && window.sys) op.addEventListener('click', function(){ window.sys.openFolder() });

    if (d) d.addEventListener('click', async function(){
      var pass = prompt('Enter wallet passphrase');
      if (!pass) return;
      var path = prompt('Enter full .txt path to save (e.g. /Users/you/Desktop/wallet_dump.txt)');
      if (!path || !/\.txt$/i.test(path)) { alert('Path must end with .txt'); return; }
      try {
        await rpc('walletpassphrase',[pass,60]);
        await rpc('dumpwalletRT',[path]);
        alert('Dump complete to:\n'+path);
      } catch(e){ alert('Dump failed'); }
      try{ await rpc('walletlock',[]) }catch(e){}
    });

    if (imp) imp.addEventListener('click', async function(){
      var pass = prompt('Enter wallet passphrase');
      if (!pass) return;
      var path = prompt('Enter full path of dump .txt to import');
      if (!path || !/\.txt$/i.test(path)) { alert('Path must end with .txt'); return; }
      try {
        await rpc('walletpassphrase',[pass,120]);
        await rpc('importwallet',[path]);
        alert('Import started');
      } catch(e){ alert('Import failed'); }
      try{ await rpc('walletlock',[]) }catch(e){}
    });
  }

  function setupLiveTail(){
    var box=q('live-tail'), st=q('start-tail'), sp=q('stop-tail');
    if (!box || !st || !sp || !window.diag) return;
    window.diag.onData(function(line){ box.textContent += line; box.scrollTop = box.scrollHeight; });
    st.addEventListener('click', function(){ window.diag.startTail() });
    sp.addEventListener('click', function(){ window.diag.stopTail() });
  }

  function init(){ setupWalletTools(); setupLiveTail(); }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();

/* IOC_WIDGET_TOOLS_MODAL_HOOK */
function __ioc_modal(opts){
  return new Promise(function(res){
    var wrap=document.createElement('div');wrap.style.position='fixed';wrap.style.inset='0';wrap.style.background='rgba(0,0,0,.45)';wrap.style.display='flex';wrap.style.alignItems='center';wrap.style.justifyContent='center';wrap.style.zIndex='9999';
    var box=document.createElement('div');box.style.background='#0e141b';box.style.border='1px solid #12343b';box.style.borderRadius='12px';box.style.padding='16px 18px';box.style.minWidth='340px';box.style.boxShadow='0 10px 30px rgba(0,0,0,.45)';
    var h=document.createElement('div');h.textContent=opts&&opts.title?opts.title:'Input';h.style.color='#cbd5df';h.style.fontWeight='600';h.style.margin='0 0 10px';h.style.textAlign='center';
    var inp=document.createElement('input');inp.type=(opts&&opts.type)||'text';inp.placeholder=(opts&&opts.placeholder)||'';inp.value=(opts&&opts.value)||'';inp.style.width='100%';inp.style.padding='10px';inp.style.borderRadius='8px';inp.style.border='1px solid #243541';inp.style.background='#0b1117';inp.style.color='#e6f2f1';
    var row=document.createElement('div');row.style.display='flex';row.style.gap='10px';row.style.marginTop='12px';row.style.justifyContent='center';
    var ok=document.createElement('button');ok.textContent='OK';ok.className='btn';
    var ca=document.createElement('button');ca.textContent='Cancel';ca.className='btn';
    ok.onclick=function(){var v=inp.value;document.body.removeChild(wrap);res(v||null);};
    ca.onclick=function(){document.body.removeChild(wrap);res(null);};
    inp.addEventListener('keydown',function(e){if(e.key==='Enter')ok.click();if(e.key==='Escape')ca.click();});
    row.appendChild(ok);row.appendChild(ca);box.appendChild(h);box.appendChild(inp);box.appendChild(row);wrap.appendChild(box);document.body.appendChild(wrap);setTimeout(function(){inp.focus();inp.select&&inp.select();},0);
  });
}
function __ioc_defaultDumpPath(){
  var d=new Date(),y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2);
  return '/tmp/ioc-wallet-dump-'+y+m+da+'.txt';
}
async function __ioc_dump(){
  try{
    var pass=await __ioc_modal({title:'Enter wallet passphrase',type:'password',placeholder:'passphrase'}); if(!pass) return;
    var path=await __ioc_modal({title:'Save dump as absolute path (.txt) — no ~',type:'text',value:__ioc_defaultDumpPath()}); if(!path) return;
    if (/^~\//.test(path)) { alert('Use a full absolute path (no ~). Example: '+__ioc_defaultDumpPath()); return; }
    try{ await window.ioc.rpc('walletpassphrase',[pass,300]); }catch(_){}
    try{ await window.ioc.rpc('dumpwalletRT',[path]); }
    catch(e1){
      var msg=''+(e1&&e1.message?e1.message:e1);
      if(/not.*found/i.test(msg)){ await window.ioc.rpc('dumpwallet',[path]); }
      else { alert('Dump failed: '+msg); return; }
    }
    try{ await window.ioc.rpc('walletlock',[]); }catch(_){}
    alert('Dump written to:\n'+path);
  }catch(e){ alert('Dump failed'); }
}
async function __ioc_import(){
  try{
    var path=await __ioc_modal({title:'Absolute path to dump (.txt) — no ~',type:'text',placeholder:'/full/path/to/wallet-dump.txt'});
    if(!path) return;
    if (/^~\//.test(path)) { alert('Use a full absolute path (no ~)'); return; }
    await window.ioc.rpc('importwallet',[path]);
    alert('Import started:\n'+path);
  }catch(e){ alert('Import failed'); }
}
document.addEventListener('DOMContentLoaded',function(){
  var d=document.getElementById('btnDump'); if(d&&!d.__wired){ d.addEventListener('click',function(ev){ev.preventDefault();__ioc_dump();}); d.__wired=1; }
  var i=document.getElementById('btnImport'); if(i&&!i.__wired){ i.addEventListener('click',function(ev){ev.preventDefault();__ioc_import();}); i.__wired=1; }
});
/* END_IOC_WIDGET_TOOLS_MODAL_HOOK */

;(()=>{let __lastBeat=Date.now();const __kick=()=>{try{refresh();}catch(e){}};const __mark=()=>{__lastBeat=Date.now()};document.addEventListener('click',()=>{setTimeout(__kick,0)},true);const __hb=setInterval(()=>{if(Date.now()-__lastBeat>6000){__kick()}},3000);const __orig_refresh=refresh;refresh=async function(){try{await __orig_refresh()}finally{__mark()}}})();

;(()=>{if(window.__iocSyncHB)return;window.__iocSyncHB=true;setInterval(()=>{try{if(!document.hidden)refresh();}catch(e){}},4000);window.addEventListener('focus',()=>{try{refresh();}catch(e){}});})();
;(()=>{if(window.__SYNC_WATCHDOG)return;window.__SYNC_WATCHDOG=true;let __lastSyncTs=0;const __mark=()=>{__lastSyncTs=Date.now()};const __kick=()=>{try{refresh()}catch(e){}};const __wd=()=>{if(Date.now()-__lastSyncTs>5000){__kick()}};setInterval(__wd,2500);document.addEventListener('click',e=>{const t=e.target.closest&&e.target.closest('.tab');if(t){setTimeout(__kick,0)}},true);const _r=refresh;refresh=async function(){try{return await _r.apply(this,arguments)}finally{__mark()}}})();
;(()=>{ if (window.__SYNC_TICK) return; window.__SYNC_TICK = true;
  const kick = ()=>{ try { if (typeof refresh==='function') refresh(); } catch(e){} };
  setInterval(kick, 2500);
  window.addEventListener('focus', kick, {once:false});
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) kick(); }, true);
})();
;(()=>{if(window.__SYNC_PINGER)return;window.__SYNC_PINGER=true;
const kick=()=>{try{if(typeof refresh==='function'){refresh();return}}catch(e){}try{
  const tab=document.querySelector('.tab[aria-selected="true"]');
  if(tab && /overview/i.test(tab.textContent||'')) tab.click();
}catch(e){}};
setInterval(kick,3000);window.addEventListener('focus',kick);
document.addEventListener('visibilitychange',()=>{if(!document.hidden)kick();},true);
})();
;(()=>{if(window.__SYNC_RPC__)return;window.__SYNC_RPC__=true;
const rpc=(n,a=[])=>new Promise(res=>{let done=false;const to=setTimeout(()=>{if(!done){done=true;res(null)}},3000);try{const f=(window.ioc&&typeof window.ioc.rpc==='function')?window.ioc.rpc(n,a):null;if(!f){clearTimeout(to);return res(null)}f.then(v=>{if(!done){done=true;clearTimeout(to);res(v)}}).catch(()=>{if(!done){done=true;clearTimeout(to);res(null)}})}catch(e){clearTimeout(to);res(null)}});
const tick=async()=>{const local=await rpc('getblockcount');let net=await rpc('getnumblocksofpeers');if(!(net>0)){const mi=await rpc('getmininginfo');if(mi&&mi.blocks)net=mi.blocks}if(!(net>=0))net=0;if(!(local>=0))net=local||0;if(net<local)net=local;const pct=net?Math.round((local/net)*100):0;if(typeof setSync==='function'){setSync(pct,`Syncing wallet (${local||0} / ${net||0} blocks)`)}else{const t=document.getElementById('syncText');if(t)t.textContent=`Syncing wallet (${local||0} / ${net||0} blocks)`;const b=document.getElementById('syncbar');if(b)b.style.width=(pct||0)+'%'}};
setInterval(tick,3000);window.addEventListener('focus',()=>{setTimeout(tick,0)});document.addEventListener('visibilitychange',()=>{if(!document.hidden)tick()});setTimeout(tick,200);
})();function __ensureHistoryScroller(){
  const pane = document.querySelector('#history-pane');
  if(!pane) return;
  let scroller = pane.querySelector('.history-scroller');
  if(!scroller){
    const table = pane.querySelector('table');
    if(!table) return;
    scroller = document.createElement('div');
    scroller.className = 'history-scroller';
    const parent = table.parentNode;
    parent.replaceChild(scroller, table);
    scroller.appendChild(table);
  }
  const rect = pane.getBoundingClientRect();
  const available = Math.max(260, window.innerHeight - rect.top - 160);
  scroller.style.maxHeight = available + 'px';
}
window.addEventListener('resize', __ensureHistoryScroller);
document.addEventListener('DOMContentLoaded', __ensureHistoryScroller);
window.addEventListener('hashchange', __ensureHistoryScroller);
new MutationObserver(__ensureHistoryScroller).observe(document.documentElement,{subtree:true,childList:true});

(() => {
  console.log("BACKUP button injector runs here");
})();


/* ===== Wallet Tools layout normalizer ===== */
(() => {
  const normalizeWalletTools = () => {
    // Find the Wallet Tools button row
    const tools =
      document.querySelector('[data-panel="wallet-tools"]') ||
      document.getElementById('wallet-tools') ||
      Array.from(document.querySelectorAll('.panel,.card,.group,.section'))
        .find(el => /wallet\s*tools/i.test(el.textContent || ''));

    if (!tools) return false;

    let row = tools.querySelector('.btn-row');
    if (!row) {
      row = tools.querySelector('div');
    }
    if (!row) return false;

    // Row layout
    row.style.display = 'flex';
    row.style.flexWrap = 'wrap';
    row.style.justifyContent = 'center';
    row.style.gap = '16px';

    // Normalize every button inside Wallet Tools
    const btns = Array.from(row.querySelectorAll('button'));
    btns.forEach(b => {
      b.style.flex = '0 0 auto';   // don't stretch
      b.style.width = 'auto';
      b.style.minWidth = '';       // clear any minWidth left over
      b.style.padding = '6px 16px';
      b.style.margin = '0';
      b.style.boxSizing = 'border-box';
    });

    // Ensure our BACKUP button specifically is not wider than others
    const backup = document.getElementById('backupWalletBtn');
    if (backup) {
      backup.style.flex = '0 0 auto';
      backup.style.width = 'auto';
      backup.style.minWidth = '';
      backup.style.padding = '6px 16px';
    }

    return true;
  };

  // Run now and also when Settings mounts
  if (!normalizeWalletTools()) {
    const mo = new MutationObserver(() => { if (normalizeWalletTools()) mo.disconnect(); });
    mo.observe(document.documentElement, { childList: true, subtree: true });
    setTimeout(normalizeWalletTools, 500);
    setTimeout(normalizeWalletTools, 1200);
  }
})();
/// ===== end normalizer =====


(function(){
  if(window.__accentRuntimeInit)return; window.__accentRuntimeInit=true;

  function ensureStyle(){
    if(document.getElementById('accent-style')) return;
    var css = `
:root{--accent:#20e0d0}
.btn,.btn.primary{background:var(--accent) !important;border-color:var(--accent) !important}
.btn:hover{filter:brightness(1.05)}
.tab.is-active,.tab.active{box-shadow:0 0 0 2px var(--accent) inset !important}
.rule-accent,.accent{background:var(--accent) !important}
#syncbar{background:var(--accent) !important}
svg [data-accent="fill"]{fill:var(--accent) !important}
svg [data-accent="stroke"]{stroke:var(--accent) !important}
#accentPick{width:44px;height:32px;border:1px solid var(--border,#293442);border-radius:6px;background:#0e1420;padding:0}
.accent-row{display:flex;gap:10px;align-items:center;margin-top:8px}
.theme-card{margin-top:14px}
.theme-card .card-title{font-weight:600;margin-bottom:8px}
`;
    var el = document.createElement('style'); el.id='accent-style'; el.textContent = css; document.head.appendChild(el);
  }

  function setAccent(c){
    document.documentElement.style.setProperty('--accent', c);
    try{ localStorage.setItem('accent', c) }catch(e){}
  }
  function getAccent(){
    try{ return localStorage.getItem('accent') || '' }catch(e){ return '' }
  }

  function injectSettings(){
    var tab = document.getElementById('tab-settings');
    if(!tab || document.getElementById('accentPick')) return;

    var card = document.createElement('div');
    card.className = 'card theme-card';
    card.innerHTML =
      '<div class="card-title">Theme</div>' +
      '<div class="accent-row">' +
        '<input type="color" id="accentPick" value="#2da1dd">' +
        '<button id="accentApply" class="btn">APPLY</button>' +
        '<button id="accentReset" class="btn">RESET</button>' +
      '</div>';

    // Prefer placing after Wallet Tools; else append at end
    var anchor = Array.from(tab.querySelectorAll('.card,.section')).find(x=>{
      return /wallet\s*tools/i.test(x.textContent||'');
    });
    if(anchor && anchor.parentNode){
      anchor.parentNode.insertBefore(card, anchor.nextSibling);
    }else{
      tab.appendChild(card);
    }

    var saved = getAccent();
    if(saved){ setAccent(saved); var p=document.getElementById('accentPick'); if(p) p.value=saved; }

    var a = document.getElementById('accentApply');
    if(a){ a.addEventListener('click', function(){
      var v = (document.getElementById('accentPick')||{}).value || '#2da1dd';
      setAccent(v);
    });}
    var r = document.getElementById('accentReset');
    if(r){ r.addEventListener('click', function(){
      setAccent('#20e0d0');
      var p=document.getElementById('accentPick'); if(p) p.value='#20e0d0';
    });}
  }

  function init(){
    ensureStyle();
    var saved = getAccent(); if(saved) setAccent(saved);
    injectSettings();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  }else{
    init();
  }
})();


// === Global Accent Recolor (teal -> var(--accent)) ===
(function(){
  if (window.__accentGlobalRecolor) return; window.__accentGlobalRecolor = true;

  // Old teal palette (hex & rgb variants) we want to override
  const TEALS_HEX = new Set([
    '#20e0d0','#1fe0d0','#21dfd0','#20dfcf','#22e1d1','#2ae2d4','#14e1d0',
    '#24e0d1','#23e0d1'
  ].map(s=>s.toLowerCase()));

  // Parse "rgb(...)" or "rgba(...)" to [r,g,b,a]
  function toRGBA(s){
    if(!s) return null;
    s = (''+s).trim().toLowerCase();
    const m = s.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)$/i);
    if(!m) return null;
    return [parseInt(m[1]),parseInt(m[2]),parseInt(m[3]), m[4]==null?1:parseFloat(m[4])];
  }
  function rgbToHex([r,g,b]) {
    return '#' + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
  }
  // Is “roughly teal”? (tolerance for slight theme variations)
  function approxTeal(r,g,b){
    // target ~ (32,224,208)
    const t = [32,224,208], tol = 20;
    return Math.abs(r-t[0])<=tol && Math.abs(g-t[1])<=tol && Math.abs(b-t[2])<=tol;
  }
  function isTealColor(val) {
    if(!val) return false;
    let v = (''+val).trim().toLowerCase();
    if (TEALS_HEX.has(v)) return true;
    const rgba = toRGBA(v);
    if (rgba){
      const [r,g,b] = rgba;
      if (approxTeal(r,g,b)) return true;
      const hex = rgbToHex([r,g,b]);
      if (TEALS_HEX.has(hex)) return true;
    }
    return false;
  }

  // Box-shadow can carry color strings; replace teal-like pieces
  function normalizeShadow(sh){
    if(!sh) return sh;
    let v = (''+sh);
    // Replace any rgb(a) teal-ish with var(--accent)
    v = v.replace(/rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+(?:\s*,\s*[0-9.]+)?\s*\)/gi, (m)=>{
      const rgba = toRGBA(m);
      return (rgba && approxTeal(rgba[0],rgba[1],rgba[2])) ? 'var(--accent)' : m;
    });
    // Replace direct hex teals
    TEALS_HEX.forEach(hex=>{
      v = v.replace(new RegExp(hex,'gi'),'var(--accent)');
    });
    return v;
  }

  // Apply inline overrides to any element that uses teal
  const COLOR_PROPS = [
    'color','backgroundColor','borderTopColor','borderRightColor','borderBottomColor','borderLeftColor','outlineColor'
  ];
  function recolorElement(el){
    try{
      const cs = getComputedStyle(el);
      let changed = false;

      // Colors
      COLOR_PROPS.forEach(prop=>{
        const val = cs[prop];
        if (isTealColor(val)) {
          el.style[prop] = 'var(--accent)';
          changed = true;
        }
      });

      // Box shadow
      if (cs.boxShadow && /rgb|#/.test(cs.boxShadow)) {
        const replaced = normalizeShadow(cs.boxShadow);
        if (replaced !== cs.boxShadow) {
          el.style.boxShadow = replaced;
          changed = true;
        }
      }

      // SVG: map teal fills/strokes to currentColor, then set color to var(--accent)
      if (el.tagName === 'SVG' || el.querySelector && el.querySelector('svg')){
        const svgs = el.tagName==='SVG' ? [el] : el.querySelectorAll('svg');
        svgs.forEach(svg=>{
          svg.querySelectorAll('*').forEach(n=>{
            const gs = getComputedStyle(n);
            const f = gs.fill, st = gs.stroke;
            if (isTealColor(f)) { n.style.fill = 'currentColor'; svg.style.color='var(--accent)'; changed=true; }
            if (isTealColor(st)) { n.style.stroke = 'currentColor'; svg.style.color='var(--accent)'; changed=true; }
          });
        });
      }

      return changed;
    }catch(e){ return false; }
  }

  function walk(root){
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
    let node = root.nodeType===1 ? root : walker.nextNode();
    if(root.nodeType===1) recolorElement(root);
    while(node = walker.nextNode()){
      recolorElement(node);
    }
  }

  function recolorAll(){ walk(document.body || document); }

  // Observe future DOM changes so new nodes get the accent too
  const mo = new MutationObserver((muts)=>{
    for(const m of muts){
      for(const n of m.addedNodes){
        if (n.nodeType===1) walk(n);
      }
    }
  });

  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>{
      recolorAll();
      try{ mo.observe(document.body, {childList:true, subtree:true}); }catch(e){}
    }, {once:true});
  } else {
    recolorAll();
    try{ mo.observe(document.body, {childList:true, subtree:true}); }catch(e){}
  }
})();





/* ===== BACKUP button injector (clean, single handler, no status text) ===== */
(()=>{ if(window.__IOC_BACKUP_ONE) return; window.__IOC_BACKUP_ONE = true;
  const getInvoke = () => (
    (window.electron && window.electron.ipcRenderer && window.electron.ipcRenderer.invoke) ? window.electron.ipcRenderer.invoke.bind(window.electron.ipcRenderer)
    : (window.api && window.api.invoke) ? window.api.invoke.bind(window.api)
    : null
  );
  function install(){
    const panel = document.querySelector('[data-panel="wallet-tools"]') || document;
    const btns  = Array.from(panel.querySelectorAll('button,.btn'));
    const open  = btns.find(b => ((b.textContent||'').trim().toUpperCase())==='IOC FOLDER')
               || btns.find(b => /OPEN DEFAULT PATH/i.test(b.textContent||''));
    if(!open) return false;

    let bak = document.getElementById('backupWalletBtn');
    if(!bak){
      bak = document.createElement('button');
      bak.id = 'backupWalletBtn';
      bak.className = open.className || 'btn';
      bak.textContent = 'BACKUP';
      open.parentElement && open.parentElement.insertBefore(bak, open.nextSibling);
    }
    if(bak.__wired) return true;
    bak.__wired = true;
    bak.addEventListener('click', async (e)=>{
      e.preventDefault();
      const invoke = getInvoke(); if(!invoke) return;
      bak.disabled = true;
      try { await invoke('ioc:wallet:backup'); } finally { bak.disabled = false; }
    }, true);
    return true;
  }
  if(!install()){
    const mo = new MutationObserver(()=>{ if(install()) mo.disconnect(); });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }
})();
/// ===== end injector =====



// /* HISTORY_AMT_ALIGN */
document.addEventListener('DOMContentLoaded', function(){
  try{
    var s=document.createElement('style');
    s.textContent = '.tx-amt{text-align:right;min-width:64px;padding-right:8px;} .tx-when{padding-right:10px;} .tx-addr{word-break:break-all;}';
    document.head.appendChild(s);
  }catch(_){}
});


/* --- History table layout (When | Amount | Address/Txid) --- */
function ensureHistoryLayout(){
  try{
    const tbody = document.getElementById('txrows'); if(!tbody) return;
    const table = tbody.closest('table'); if(!table) return;

    // Inject styles once
    if(!document.getElementById('hist-col-style')){
      const css = `
        /* history table: fix column widths + right-align numbers + let addresses show fully */
        #tab-history table col.when { width: 240px; }     /* Date/Time */
        #tab-history table col.amt  { width: 90px; }      /* Amount   */
        #tab-history td.num { text-align: right; padding-right: 12px; }
        #tab-history td.addr {
          font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
          white-space: nowrap; overflow: visible; text-overflow: unset;
        }
      `;
      const st = document.createElement('style');
      st.id = 'hist-col-style'; st.textContent = css;
      document.head.appendChild(st);
    }

    // Add a colgroup that locks the first two column widths; address flexes
    if(!table.querySelector('colgroup')){
      const cg = document.createElement('colgroup');
      const c1 = document.createElement('col'); c1.className = 'when';
      const c2 = document.createElement('col'); c2.className = 'amt';
      const c3 = document.createElement('col'); // address/txid takes remaining width
      cg.appendChild(c1); cg.appendChild(c2); cg.appendChild(c3);
      table.insertBefore(cg, table.firstChild);
    }
  }catch(_){}
}

// === History table (When / Amount / Address) ===
async function loadHistory() {
  try {
    const rows = await window.ioc.listTx(50);
    const tbody = document.getElementById('txrows');
    if (!tbody) return;

    tbody.innerHTML = '';
    rows.forEach(t => {
      const tr = document.createElement('tr');
      const when = new Date(((t.timereceived ?? t.time) || 0) * 1000).toLocaleString();
      const amt  = Number(t.amount || 0);

      const addr = (t.address || t.txid || '').toString();

      tr.innerHTML = `
        <td class="c-when">${when}</td>
        <td class="c-amt">${amt}</td>
        <td class="c-addr" title="${addr}">${addr}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (_) {
    // no-op; keep UI responsive even if daemon isn't ready
  }
}

// One-time CSS for history column widths/alignment
(() => {
  if (document.getElementById('history-cols-style')) return;
  const css = `
    #history-pane table { table-layout: fixed; width: 100%; }
    #history-pane th, #history-pane td { padding: 10px 12px; }
    /* column widths: When ~38%, Amount ~12%, Address gets the rest */
    #history-pane thead th:nth-child(1),
    #history-pane tbody td.c-when { width: 38%; text-align: left; }
    #history-pane thead th:nth-child(2),
    #history-pane tbody td.c-amt  { width: 12%; text-align: right; }
    #history-pane thead th:nth-child(3),
    #history-pane tbody td.c-addr { width: 50%; text-align: left; white-space: nowrap; overflow: visible; text-overflow: clip; }
  `;
  const el = document.createElement('style');
  el.id = 'history-cols-style';
  el.textContent = css;
  document.head.appendChild(el);
})();
;(function(){
  try{
    if(document.getElementById('history-align-patch')) return;
    const st = document.createElement('style');
    st.id = 'history-align-patch';
    st.textContent = `
      section[data-panel="history"] table th,
      section[data-panel="history"] table td{
        text-align: left !important;
      }
      /* Address / Txid is the 3rd column after removing Type */
      section[data-panel="history"] table td:nth-child(3),
      section[data-panel="history"] table th:nth-child(3){
        text-align: left !important;
        white-space: normal !important;
        word-break: break-all !important;
        overflow: visible !important;
        text-overflow: clip !important;
        max-width: none !important;
      }
    `;
    document.addEventListener('DOMContentLoaded', ()=>document.head.appendChild(st));
  }catch(_){}
})();
;(function(){
  try{
    if(document.getElementById('history-realalign-v2')) return;
    const st = document.createElement('style');
    st.id = 'history-realalign-v2';
    st.textContent = `
      /* Make the history table fill the panel and align left */
      section[data-panel="history"] table{
        width:100% !important;
        table-layout:auto !important;
        margin:0 !important;
      }
      /* Left-align everything and reduce heavy left padding */
      section[data-panel="history"] table th,
      section[data-panel="history"] table td{
        text-align:left !important;
        padding-left:12px !important;
        padding-right:12px !important;
        white-space:normal !important;
        overflow:visible !important;
        text-overflow:clip !important;
        max-width:none !important;
      }
      /* Allocate widths: When ~260px, Amount ~80px, Address takes the rest */
      section[data-panel="history"] table th:nth-child(1),
      section[data-panel="history"] table td:nth-child(1){ width:260px !important; }
      section[data-panel="history"] table th:nth-child(2),
      section[data-panel="history"] table td:nth-child(2){ width:80px !important; }
      section[data-panel="history"] table th:nth-child(3),
      section[data-panel="history"] table td:nth-child(3){
        width:auto !important;
        white-space:normal !important;
        word-break:break-all !important;   /* show full address/txid by wrapping */
      }
    `;
    const mount = () => document.head.appendChild(st);
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', mount, { once:true });
    } else { mount(); }
  }catch(_){}
})();
/* history-force-left-v3: robust column control for History table */
;(function(){
  const ID = 'history-force-left-v3';
  if (window[ID]) return; window[ID] = true;

  function findHistoryTable(){
    // Look for a heading that says "History", then grab the first table inside same card/container.
    const headings = Array.from(document.querySelectorAll('h1,h2,h3,h4,h5,.title,.card-title'));
    const histHead = headings.find(h => /history/i.test(h.textContent || ''));
    if(!histHead) return null;
    // Walk up to the card/container
    let card = histHead.closest('.card, section, div');
    if(!card) card = histHead.parentElement;
    if(!card) return null;
    const tbl = card.querySelector('table');
    return tbl || null;
  }

  function ensureColgroup(table){
    // Remove any previous colgroup we added
    const old = table.querySelector('colgroup[data-history-cols]');
    if (old) old.remove();
    const cg = document.createElement('colgroup');
    cg.setAttribute('data-history-cols','');
    // When ~260px, Amount ~80px, Address auto (fills remaining)
    const cWhen = document.createElement('col');   cWhen.style.width = '260px';
    const cAmt  = document.createElement('col');   cAmt.style.width  = '80px';
    const cAddr = document.createElement('col');   cAddr.style.width = 'auto';
    cg.append(cWhen, cAmt, cAddr);
    table.prepend(cg);
  }

  function leftAlign(table){
    table.style.width = '100%';
    table.style.tableLayout = 'auto';
    table.style.margin = '0';

    const cells = table.querySelectorAll('th,td');
    cells.forEach(el => {
      el.style.textAlign   = 'left';
      el.style.paddingLeft = '12px';
      el.style.paddingRight= '12px';
      el.style.whiteSpace  = 'normal';
      el.style.overflow    = 'visible';
      el.style.textOverflow= 'clip';
      el.style.maxWidth    = 'none';
      el.style.wordBreak   = 'break-all'; // long address/txid wraps
    });
  }

  function normalizeHeaders(table){
    const ths = Array.from(table.querySelectorAll('thead th'));
    // If headers exist and still include a stray "Type", remove that column from DOM
    const typeIdx = ths.findIndex(th => /type/i.test(th.textContent||''));
    if (typeIdx >= 0){
      // remove header + matching td in each row
      ths[typeIdx].remove();
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if (tds[typeIdx]) tds[typeIdx].remove();
      });
    }
    // If headers are fewer than 3, we can't assign widths reliably
    // but we still try to left-align.
  }

  function apply(){
    const table = findHistoryTable();
    if(!table) return;
    normalizeHeaders(table);
    ensureColgroup(table);
    leftAlign(table);
  }

  const run = ()=>{ try{ apply(); }catch(e){} };

  // Initial + DOM readiness
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once:true });
  } else { run(); }

  // Keep it sticky across resizes, tab switches, or live updates
  window.addEventListener('resize', run);
  window.addEventListener('hashchange', run);
  new MutationObserver(()=>run()).observe(document.documentElement, {subtree:true, childList:true});
})();
/* history-columns-v4: force 3-column History and remove "Type" */
;(function(){
  const ID='history-columns-v4';
  if (window[ID]) return; window[ID]=true;

  function findHistoryTable(){
    // Prefer tables whose header cells contain When/Amount
    const tables=[...document.querySelectorAll('table')];
    for (const tbl of tables){
      const ths=[...tbl.querySelectorAll('thead th')].map(th=>th.textContent.trim().toLowerCase());
      if (ths.length && ths.some(t=>t.includes('when')) && ths.some(t=>t.includes('amount'))) {
        return tbl;
      }
    }
    // Fallback: heading "History" then first table under same card
    const head=[...document.querySelectorAll('h1,h2,h3,h4,h5,.title,.card-title')].find(h=>/history/i.test(h.textContent||''));
    if(head){
      const card=head.closest('.card, section, div')||head.parentElement;
      if(card){ const t=card.querySelector('table'); if(t) return t; }
    }
    return null;
  }

  function removeTypeColumn(table){
    const ths=[...table.querySelectorAll('thead th')];
    const idx=ths.findIndex(th=>/^\s*type\s*$/i.test(th.textContent||''));
    if(idx>=0){
      ths[idx].remove();
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const cells=tr.querySelectorAll('td');
        if(cells[idx]) cells[idx].remove();
      });
    }
  }

  function installStyleOnce(){
    if(document.getElementById('history-columns-v4-style')) return;
    const css=`
      /* Force layout & left alignment, show full address (wrap if needed) */
      table[data-history-forced]{
        table-layout:fixed !important;
        width:100% !important;
        border-collapse:separate !important;
      }
      table[data-history-forced] thead th,
      table[data-history-forced] tbody td{
        text-align:left !important;
        padding-left:12px !important;
        padding-right:12px !important;
        white-space:normal !important;
        overflow:visible !important;
        text-overflow:clip !important;
        max-width:none !important;
        word-break:break-all !important; /* ensures long base58 wraps */
      }
      /* Column widths: When ~260px, Amount ~80px (right-aligned), Address fills */
      table[data-history-forced] thead th:nth-child(1),
      table[data-history-forced] tbody td:nth-child(1){
        width:260px !important; white-space:nowrap !important;
      }
      table[data-history-forced] thead th:nth-child(2),
      table[data-history-forced] tbody td:nth-child(2){
        width:80px !important; text-align:right !important; white-space:nowrap !important;
      }
      table[data-history-forced] thead th:nth-child(3),
      table[data-history-forced] tbody td:nth-child(3){
        width:auto !important;
      }
      /* Kill common truncation classes if present */
      table[data-history-forced] .truncate,
      table[data-history-forced] .ellipsis{
        overflow:visible !important; text-overflow:clip !important; white-space:normal !important; max-width:none !important;
      }
    `.replace(/\s+/g,' ');
    const style=document.createElement('style');
    style.id='history-columns-v4-style';
    style.textContent=css;
    document.head.appendChild(style);
  }

  function apply(){
    installStyleOnce();
    const tbl=findHistoryTable();
    if(!tbl) return;
    removeTypeColumn(tbl);
    // Mark and enforce 3 columns by ensuring exactly 3 header cells
    tbl.setAttribute('data-history-forced','1');

    // If headers aren’t exactly 3 (e.g., extra blank th), trim to 3
    const ths=[...tbl.querySelectorAll('thead th')];
    if (ths.length>3){
      // keep When, Amount, Address columns by position heuristics:
      // Find the first th that matches /when/i, first matching /amount/i, and last one for address
      const when = ths.find(th=>/when/i.test(th.textContent||'')) || ths[0];
      const amt  = ths.find(th=>/amount/i.test(th.textContent||'')) || ths[1] || ths[0];
      const addr = ths.find(th=>/addr|tx/i.test(th.textContent||'')) || ths[2] || ths[ths.length-1];
      const keep=[when,amt,addr];
      ths.forEach(th=>{ if(!keep.includes(th)) th.remove(); });
      // remove matching body cells by index gaps
      const idxs = keep.map(k=>[...k.parentElement.children].indexOf(k));
      tbl.querySelectorAll('tbody tr').forEach(tr=>{
        const tds=[...tr.children];
        tds.forEach((td,i)=>{ if(!idxs.includes(i)) td.remove(); });
      });
    }
  }

  const run=()=>{ try{ apply(); }catch(_){} };
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', run, {once:true}); } else { run(); }
  window.addEventListener('hashchange', run);
  window.addEventListener('resize', run);
  new MutationObserver(()=>run()).observe(document.documentElement,{subtree:true, childList:true});
})();

// --- begin: enforced History column layout (id=history-columns) ---
(function historyColumnsInstaller(){
  function ensureHistoryColumns(){
    try{
      // remove older injections if any
      for (const id of ['history-columns','amount-left-tight']) {
        const old = document.getElementById(id); if (old) old.remove();
      }
      const s = document.createElement('style');
      s.id = 'history-columns';
      s.textContent = `
        /* Lock table width rules for History only */
        #history table, .history table { table-layout: fixed !important; width: 100% !important; }

        /* Normalize cell padding */
        #history table th, #history table td,
        .history table th, .history table td { padding: 6px 8px !important; }

        /* Column 1: When (fit the timestamp, left aligned) */
        #history table th:nth-child(1), #history table td:nth-child(1),
        .history table th:nth-child(1), .history table td:nth-child(1) {
          width: 200px !important; min-width: 200px !important; max-width: 220px !important;
          text-align: left !important;
        }

        /* Column 2: Amount (make very narrow, left aligned) */
        #history table th:nth-child(2), #history table td:nth-child(2),
        .history table th:nth-child(2), .history table td:nth-child(2) {
          width: 56px !important; min-width: 48px !important; max-width: 64px !important;
          text-align: left !important; padding-left: 4px !important; padding-right: 4px !important;
        }

        /* Column 3: Address / Txid (take everything else, wrap nicely) */
        #history table th:nth-child(3), #history table td:nth-child(3),
        .history table th:nth-child(3), .history table td:nth-child(3) {
          width: calc(100% - 256px) !important;   /* 200 (when) + ~56 (amount) */
          white-space: normal !important;          /* allow multi-line */
          word-break: break-word !important;       /* wrap long strings */
          overflow: visible !important;
          text-align: left !important;
        }
      `;
      document.head.appendChild(s);
    }catch(e){ console.warn('History column styler skipped:', e); }
  }
  document.addEventListener('DOMContentLoaded', ensureHistoryColumns);
  window.addEventListener('hashchange', ensureHistoryColumns);
  // In case History is already rendered
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    requestAnimationFrame(ensureHistoryColumns);
  }
})();
// --- end: enforced History column layout ---

// ===== History table colgroup enforcer (id: hist-colgroup-enforcer) =====
(function installHistColgroupEnforcer(){
  const ID = 'hist-colgroup-enforcer';
  if (window[ID]) return; // avoid double-install
  window[ID] = true;

  function headerText(th){ return (th?.textContent || '').trim().toLowerCase(); }
  function looksLikeHistoryTable(tbl){
    const ths = tbl.querySelectorAll('thead th');
    if (!ths.length) return false;
    let names = Array.from(ths).map(headerText);
    // accept "address" or "address / txid" style headers
    const hasWhen   = names.some(t => t.startsWith('when'));
    const hasAmount = names.some(t => t.startsWith('amount'));
    const hasAddr   = names.some(t => t.startsWith('address'));
    return hasWhen && hasAmount && hasAddr;
  }

  function applyColgroup(tbl){
    if (!tbl || tbl.__histColsApplied) return;

    // Ensure table layout is fixed so col widths are respected
    tbl.style.tableLayout = 'fixed';
    tbl.style.width = '100%';

    // Remove any previous colgroup we added
    const old = tbl.querySelector('colgroup[data-hist="1"]');
    if (old) old.remove();

    const cg = document.createElement('colgroup');
    cg.setAttribute('data-hist','1');

    const cWhen   = document.createElement('col');
    const cAmount = document.createElement('col');
    const cAddr   = document.createElement('col');

    cWhen.style.width   = '200px';
    cWhen.style.minWidth= '200px';
    cAmount.style.width = '64px';
    cAmount.style.minWidth = '56px';
    cAddr.style.width   = 'auto';

    cg.append(cWhen, cAmount, cAddr);
    tbl.insertBefore(cg, tbl.firstChild);

    // Force left align on amount, wrap address
    const rows = tbl.querySelectorAll('tbody tr');
    rows.forEach(tr=>{
      const tds = tr.children;
      if (tds[1]) {
        tds[1].style.textAlign = 'left';
        tds[1].style.paddingLeft = '4px';
        tds[1].style.paddingRight= '4px';
      }
      if (tds[2]) {
        Object.assign(tds[2].style, {
          whiteSpace: 'normal',
          wordBreak: 'break-word',
          overflow: 'visible',
          textAlign: 'left'
        });
      }
    });

    // Header alignment to match
    const ths = tbl.querySelectorAll('thead th');
    if (ths[1]) ths[1].style.textAlign = 'left';
    if (ths[2]) ths[2].style.textAlign = 'left';

    tbl.__histColsApplied = true;
  }

  function scan(){
    document.querySelectorAll('table').forEach(tbl=>{
      if (looksLikeHistoryTable(tbl)) applyColgroup(tbl);
    });
  }

  // Run now & on view changes/renders
  const kickoff = ()=> requestAnimationFrame(scan);
  document.addEventListener('DOMContentLoaded', kickoff);
  window.addEventListener('hashchange', kickoff);
  new MutationObserver(() => { scan(); }).observe(document.documentElement, {subtree:true, childList:true});

  // If already interactive, apply once immediately
  if (document.readyState !== 'loading') kickoff();
})();
 // ===== end history colgroup enforcer =====

(function(){
  if(document.getElementById("history-col-tune")) return;
  const s=document.createElement("style");
  s.id="history-col-tune";
  s.textContent=`
    .history-table th, .history-table td { vertical-align: middle; }
    .history-table .col-amount { width:44px; text-align:left; }
    .history-table td.col-amount, .history-table th.col-amount { text-align:left; }
    .history-table .col-address { min-width:420px; }
  `;
  document.addEventListener("DOMContentLoaded",()=>document.head.appendChild(s));
})();

// __HIST_COL_FIX__: keep history columns readable without touching daemon/render logic.
(() => {
  const css = `
    /* Scope to the History view only */
    #history table { table-layout: fixed; width: 100%; }

    /* Amount column (2nd): narrower and left-aligned */
    #history table thead th:nth-child(2),
    #history table tbody td:nth-child(2) {
      width: 76px;         /* compact */
      padding-left: 8px;   /* nudge left */
      text-align: left;    /* no right centering */
      white-space: nowrap;
    }

    /* Address / Txid column (3rd): use the rest, avoid wrapping */
    #history table thead th:nth-child(3),
    #history table tbody td:nth-child(3) {
      padding-left: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  `.trim();

  const style = document.createElement('style');
  style.setAttribute('data-tag', '__HIST_COL_FIX__');
  style.textContent = css;
  document.addEventListener('DOMContentLoaded', () => {
    document.head.appendChild(style);
  });
})();

// __HIST_FONT_FIX__: adjust font size + column widths for History table
(() => {
  const css = `
    #history table {
      table-layout: fixed;
      width: 100%;
      font-size: 12px; /* smaller font */
    }
    /* Amount column */
    #history table thead th:nth-child(2),
    #history table tbody td:nth-child(2) {
      width: 76px;
      padding-left: 8px;
      text-align: left;
      white-space: nowrap;
    }
    /* Address / Txid column */
    #history table thead th:nth-child(3),
    #history table tbody td:nth-child(3) {
      padding-left: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  `.trim();

  const style = document.createElement('style');
  style.setAttribute('data-tag', '__HIST_FONT_FIX__');
  style.textContent = css;
  document.addEventListener('DOMContentLoaded', () => {
    document.head.appendChild(style);
  });
})();
;(function(){
  if (window['topbar-static-v1']) return; window['topbar-static-v1']=true;

  function pickHeader(){
    return document.querySelector('header,[role="banner"],.topbar,.navbar,.app-header,.header');
  }
  function pickMain(hdr){
    if (!hdr) return null;
    const p = hdr.parentElement;
    const next = hdr.nextElementSibling;
    if (next) return next;
    if (p && p.children.length>1) return p.children[1];
    return document.querySelector('main,.main,.content,#content,.app-content') || p;
  }
  function apply(){
    const hdr = pickHeader(); if(!hdr) return;
    const main = pickMain(hdr); if(!main) return;

    hdr.style.position = 'sticky';
    hdr.style.top = '0';
    hdr.style.zIndex = '1000';
    if (!getComputedStyle(hdr).backgroundColor || getComputedStyle(hdr).backgroundColor==='rgba(0, 0, 0, 0)'){
      hdr.style.background = 'var(--bg, #0b0b0b)';
    }

    const h = Math.ceil(hdr.getBoundingClientRect().height) || 64;
    const vh = window.innerHeight || document.documentElement.clientHeight || 800;
    const targetH = Math.max(200, vh - h) + 'px';

    main.style.height = targetH;
    main.style.maxHeight = targetH;
    main.style.overflowY = 'auto';
    main.style.overflowX = 'hidden';

    document.querySelectorAll('section[data-panel], .tab-panel, .pane, .card-body').forEach(el=>{
      if (el === hdr) return;
      if (el.closest('header,[role="banner"],.topbar,.navbar,.app-header,.header')) return;
      el.style.overflowY = el.style.overflowY || 'auto';
      el.style.maxHeight = el.style.maxHeight || '100%';
    });
  }

  const run = ()=>{ try{ apply(); }catch(e){} };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once:true });
  } else {
    run();
  }
  window.addEventListener('resize', run);
  window.addEventListener('hashchange', run);
  new MutationObserver(()=>run()).observe(document.documentElement,{subtree:true,childList:true});
})();
// FIXED_TOP_SCROLL_V2
(function(){
  const ID='fixed-top-scroll-v2'; if (window[ID]) return; window[ID]=true;

  // Inject high-specificity CSS once
  if (!document.getElementById('fixed-top-scroll-style')) {
    const st = document.createElement('style'); st.id='fixed-top-scroll-style';
    st.textContent = `
      html, body { height:100% !important; overflow:hidden !important; }
      header, [role="banner"], .topbar, .navbar, .app-header, .header {
        position: sticky !important; top: 0 !important; z-index: 1000 !important;
        /* ensure the bar paints over content */
        background: var(--hdr-bg, rgba(0,0,0,0.8)) !important;
        backdrop-filter: saturate(120%) blur(0.5px);
      }
      /* Only the chosen region scrolls */
      .__ioc_scroll_region__ {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        height: calc(100vh - var(--hdrH, 64px)) !important;
        max-height: calc(100vh - var(--hdrH, 64px)) !important;
      }
      /* Prevent nested panes from introducing second scrollbars */
      .__ioc_scroll_region__ .pane, 
      .__ioc_scroll_region__ .tab-panel,
      .__ioc_scroll_region__ .card-body {
        overscroll-behavior: contain;
        max-height: none !important;
        overflow: visible !important;
      }
    `;
    document.head.appendChild(st);
  }

  function pickHeader(){
    return document.querySelector('header,[role="banner"],.topbar,.navbar,.app-header,.header');
  }

  function pickScrollRegion(hdr){
    if (!hdr) return null;
    // Prefer the immediate sibling after header
    let cand = hdr.nextElementSibling;
    // Fallbacks if layout nests content deeper
    const fbs = [
      cand,
      document.querySelector('main'),
      document.querySelector('#content'),
      document.querySelector('.content'),
      document.querySelector('.app-content'),
      document.querySelector('.container'),
      document.querySelector('section[data-panel]')?.parentElement
    ].filter(Boolean);
    // Choose the first element that is not the header and is displayed
    return fbs.find(el => el && el !== hdr && getComputedStyle(el).display !== 'none') || null;
  }

  function apply(){
    const hdr = pickHeader(); if (!hdr) return;
    const H = Math.ceil(hdr.getBoundingClientRect().height) || 64;
    document.documentElement.style.setProperty('--hdrH', H + 'px');
    // Ensure header paints solid background (avoid transparency over content)
    const bg = getComputedStyle(hdr).backgroundColor;
    if (!bg || bg === 'rgba(0, 0, 0, 0)') {
      hdr.style.setProperty('--hdr-bg', '#0b0b0b');
    }

    const region = pickScrollRegion(hdr);
    if (!region) return;

    // Make ONLY this region scroll
    region.classList.add('__ioc_scroll_region__');

    // Ensure ancestors don’t re-enable scrolling on body
    document.body.style.overflow = 'hidden';

    // Remove overflow from nested containers that might fight our rule
    region.querySelectorAll('[style*="overflow"]').forEach(el=>{
      // Keep explicit component behaviors; just avoid global y-scrolls on wrappers
      if (/(auto|scroll)/i.test(el.style.overflowY)) {
        el.style.overflowY = '';
      }
    });
  }

  const run = () => { try { apply(); } catch {} };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
  } else {
    run();
  }
  window.addEventListener('resize', run);
  window.addEventListener('hashchange', run);
  new MutationObserver(run).observe(document.documentElement, { childList: true, subtree: true });
})();
// FIXED_PANES_SCROLL_V3
(function(){
  const ID='FIXED_PANES_SCROLL_V3'; if (window[ID]) return; window[ID]=true;

  // High-specificity CSS: fixed header; content root fills viewport minus header; panes scroll inside.
  function injectCSS(){
    if (document.getElementById('fixed-panes-style')) return;
    const st = document.createElement('style'); st.id='fixed-panes-style';
    st.textContent = `
      /* Header stays fixed */
      header, [role="banner"], .topbar, .navbar, .app-header, .header {
        position: sticky !important;
        top: 0 !important;
        z-index: 1000 !important;
        background: var(--hdr-bg, rgba(0,0,0,0.85)) !important;
      }
      /* Root content area under header: owns layout height; not scrollable itself */
      .__ioc-content {
        position: relative !important;
        height: calc(100vh - var(--hdrH, 64px)) !important;
        max-height: calc(100vh - var(--hdrH, 64px)) !important;
        overflow: hidden !important;
      }
      /* Each pane (Overview/History/Settings): fills content area and scrolls */
      .__ioc-content > section[data-panel],
      .__ioc-content > .tab-panel,
      .__ioc-content > .pane,
      .__ioc-content > .card-body,
      .__ioc-pane {
        height: 100% !important;
        max-height: 100% !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        overscroll-behavior: contain !important;
      }
      /* Prevent nested containers from re-introducing page scrollbars */
      html, body {
        height: 100% !important;
        overflow: hidden !important;
      }
    `;
    document.head.appendChild(st);
  }

  function pickHeader(){
    return document.querySelector('header,[role="banner"],.topbar,.navbar,.app-header,.header');
  }

  function pickContentRoot(hdr){
    if (!hdr) return null;
    // Prefer the immediate sibling under the header
    let root = hdr.nextElementSibling;
    // Robust fallbacks if layout differs
    if (!root || getComputedStyle(root).display === 'none') {
      root = document.querySelector('main,#content,.content,.app-content,.container,.page,.body');
    }
    // As a last resort, try the header's parent (minus header)
    if (!root && hdr.parentElement && hdr.parentElement.children.length > 1) {
      root = hdr.parentElement.children[1];
    }
    return root || null;
  }

  function tagPanes(root){
    // Mark the root
    root.classList.add('__ioc-content');

    // Ensure direct panes are scrollable
    const directPanes = root.querySelectorAll(':scope > section[data-panel], :scope > .tab-panel, :scope > .pane, :scope > .card-body');
    if (directPanes.length) {
      directPanes.forEach(el => el.classList.add('__ioc-pane'));
    } else {
      // If panes are nested one level deeper (common), tag them too
      const nested = root.querySelectorAll('section[data-panel], .tab-panel, .pane, .card-body');
      nested.forEach(el => el.classList.add('__ioc-pane'));
    }
  }

  function apply(){
    injectCSS();

    const hdr = pickHeader();
    if (!hdr) return;

    // Measure header height and expose it as CSS var
    const H = Math.max(48, Math.ceil(hdr.getBoundingClientRect().height) || 64);
    document.documentElement.style.setProperty('--hdrH', H + 'px');

    // Ensure header has a solid background behind it
    const bg = getComputedStyle(hdr).backgroundColor;
    if (!bg || bg === 'rgba(0, 0, 0, 0)') {
      hdr.style.setProperty('--hdr-bg', '#0b0b0b');
    }

    const root = pickContentRoot(hdr);
    if (!root) return;

    tagPanes(root);
  }

  const run = () => { try { apply(); } catch(e){} };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
  } else {
    run();
  }
  window.addEventListener('resize', run);
  window.addEventListener('hashchange', run);
  new MutationObserver(run).observe(document.documentElement, { childList: true, subtree: true });
})();
